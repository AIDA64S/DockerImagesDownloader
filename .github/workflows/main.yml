name: Save Docker Image as TAR (Multi-Arch)

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: "镜像名称，默认'ubuntu'"
        required: true
        default: "ubuntu"
      image_tag:
        description: "镜像tag，默认'latest'"
        required: true
        default: "latest"
      arch:
        description: "系统架构，默认'linux/arm64'"
        required: true
        default: "linux/arm64"
jobs:
  save-image:
    runs-on: ubuntu-latest
    steps:
      - name: clean disk space
        run: |
          sudo du -h --max-depth=3 / | sort -rh | head -n 10
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/donnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf /usr/local/share/firefox
          sudo rm -rf /usr/local/lib/heroku
          sudo rm -rf /usr/local/lib/node_modules
          sudo rm -rf /usr/local/share/gradle
          sudo rm -rf /usr/lib/jvm
          sudo rm -rf /usr/local/azure-cli
          sudo rm -rf /opt/microsoft
          sudo rm -rf /usr/share/miniconda
          sudo rm -rf /usr/share/miniconda
          sudo rm -rf /var/lib/apt/lists/*
          sudo rm -rf /var/cache/apt/archives/*
          sudo rm -rf ~/.cache/*
          sudo docker system prune -af || true
          sudo docker builder prune -af || true
          df -h

      - name: Set up QEMU for multi-arch
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull & Save Docker Image
        run: |
          echo "拉取镜像: ${{ github.event.inputs.image_name }}:${{ github.event.inputs.image_tag }} (架构: ${{ github.event.inputs.arch }})"
          docker pull --platform ${{ github.event.inputs.arch }} ${{ github.event.inputs.image_name }}:${{ github.event.inputs.image_tag }}
          docker save -o images.tar ${{ github.event.inputs.image_name }}:${{ github.event.inputs.image_tag }}

      - name: Upload TAR as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-images-tar
          path: images.tar
